<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at Sep 10, 2012
 | Rendered using Apache Maven Fluido Skin 1.2.2
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nano-project :: h-ubu</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

          
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/site.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/font-awesome.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<script type="text/javascript">var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-1518442-11']);
                _gaq.push(['_trackPageview']);

                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();</script>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="shortcut icon" href="favicon.png"/>
          
    <meta name="Date-Revision-yyyymmdd" content="20120910" />
    <meta http-equiv="Content-Language" content="en" />
            </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/nano-project/h-ubu">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="#" id="bannerLeft">
                                                                                                <img src="h-ubu-small.png"  alt="h-ubu - JavaScript Componentization"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
            
                  <li id="publishDate">Last Published: 2012-09-10</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 0.0.1-SNAPSHOT</li>
                      
                
            
      
                            </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
            
                                    <h3>H-UBU</h3>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="motivations.html" title="Motivations and Concepts">Motivations and Concepts</a>
            </li>
                  <li class="none">
                          <a href="quickstart.html" title="Quickstart">Quickstart</a>
            </li>
          </ul>
                        <h3>User Guide</h3>
                  <ul>
                  <li class="none">
                          <a href="creating-and-registering-components.html" title="Creating and Registering Components">Creating and Registering Components</a>
            </li>
                  <li class="none">
                          <a href="providing-services.html" title="Providing Services">Providing Services</a>
            </li>
                  <li class="none">
                          <a href="requiring-services.html" title="Requiring Services">Requiring Services</a>
            </li>
                  <li class="none">
                          <a href="direct-injection.html" title="Direct Injection">Direct Injection</a>
            </li>
                  <li class="none">
                          <a href="receiving-and-sending-events.html" title="Receiving and Sending Events">Receiving and Sending Events</a>
            </li>
                  <li class="none">
                          <a href="testing-components.html" title="Testing Components">Testing Components</a>
            </li>
          </ul>
                        <h3>Advanced Topics</h3>
                  <ul>
                  <li class="none">
                          <a href="using-requirejs.html" title="Using require.js">Using require.js</a>
            </li>
                  <li class="none">
                          <a href="using-nodejs.html" title="Using h-ubu in node.js">Using h-ubu in node.js</a>
            </li>
                  <li class="none">
                          <a href="contract.html" title="Contract and Conformity">Contract and Conformity</a>
            </li>
                  <li class="none">
            <strong>Service-Orientation</strong>
          </li>
                  <li class="none">
                          <a href="developper-guide.html" title="Developer Guide">Developer Guide</a>
            </li>
          </ul>
                        <h3>Project Documentation</h3>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                      <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                      
            
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="http://nano-project.github.com/h-ubu" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                   
    <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>

    
    <div class="g-plusone" data-href="https://github.com/nano-project/h-ubu" data-size="tall" ></div>

                   <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Service Orientation</h1>

<p>This page explains how the service orientation is built.</p>

<h2>Concepts and OSGi</h2>

<p>H-Ubu's Service Orientation is closely related to OSGi Service Layer, so you will recognize the same concepts.
Basically, service orientation is composed by 4 entities:</p>

<ul>
<li><em>Service Specification</em> : the description of the service.</li>
<li><em>Service Registry</em> : stores the currently available services.</li>
<li><em>Service Publisher</em> : implements and publishes a service specification.</li>
<li><em>Service Consumer</em> : looks for services and uses them.</li>
</ul>

<p>H-Ubu service orientation implements these concepts using the following entities:</p>

<p><em>Service Specification</em><br/>
Services are represented by <em>specifications</em>. We use H-Ubu's <em>contract</em> as a specification. Providers implement, and
consumers require <em>contracts</em>.</p>

<p><em>Service Properties</em><br/>
Each service provider can add properties to a service. These properties will be published with the service and
then used for service selection.</p>

<p><em>Service Registration</em><br/>
When a component publishes a service to the service registry, it receives a service registration object. This object
is required to unregister the service or to modify the service properties.</p>

<p><em>Service Reference</em><br/>
When a component requires a service, it first performs a lookup within the service registry. The result of this lookup
is a list of service references. Each returned service reference contains the service properties published by the
provider. These enable service filtering and selection.</p>

<p><em>Service Binding</em><br/>
Once a component has selected the 'ideal' service reference, it can get the service object by asking the registry to
get the service object from a specific reference.</p>

<p><em>Service Events</em><br/>
Services are dynamic in nature, so can be published, modified and unpublished at any time. Consumers can <em>listen</em> for
these events by registering a service listener. The listener will be notified when an event occurs.</p>

<p><em>Service Selection and Filtering</em><br/>
Service lookups and service listeners can select services based on either the <em>contract</em> (service specification) or
service properties.</p>

<h2>Accessing the Service Registry</h2>

<p>Each <code>hub</code> has its own service registry. So, <code>hub.getServiceRegistry()</code> gives you access to the service registry.
However, the <code>hub</code> object is extended to give access to more high level functions, avoiding the need for direct access
to the registry:</p>

<ul>
<li><code>hub.registerService(component, contract, {properties})</code> : registers a service and returns the service registration</li>
<li><code>hub.unregisterService(registration)</code> : unregisters the service</li>
<li><code>hub.getServiceReferences(contract, filter)</code> : searches for service references implementing the given contract and
matching the given filter (function receiving a service reference as parameter). Both arguments are optional.
Passing no arguments results in all services being returned. If no service matches the filter, an empty list is returned.</li>
<li><code>hub.getServiceReference(contract, filter)</code> : similar to the previous method, but returns only one candidate, <code>null</code>,
if no service is matched.</li>
<li><code>hub.getService(component, reference)</code> : gets the service objects for the given reference. <code>null</code> if the reference is no longer valid.</li>
<li><code>hub.registerServiceListener(configuration)</code> : registers a service listener. The <code>configuration</code> object contains the
required <code>contract</code> (optional), the <code>filter</code> method (optional), and <code>listener</code>, the function called when a service
event matches. This method receives a <code>Service Event</code> as parameter.</li>
<li><code>hub.unregisterServiceListener(configuration)</code> : unregisters the service listener.</li>
</ul>

<h2>Service Publication</h2>

<p>Publishing a service is quite simple using the <code>registerService</code> function. Let's imagine the following contract:</p>

<pre><code>var contract = {
    doSomething : function() {}
}
</code></pre>

<p>Registering this service in the <code>start</code> method of a component is done as follows:</p>

<pre><code>start: function() {
    this.reg = hub.registerService(this, contract);
}
</code></pre>

<p>Note that we store the registration object. This registration object allow us to modify or unregister the service.</p>

<p>All services are automatically unregistered when the component stops. However, you can unregister a service at any time with:</p>

<pre><code>hub.unregisterService(this.reg);
this.reg = null;
</code></pre>

<p>Services can be published with properties. These properties allow consumers to select the right service provider.
All services are published with:</p>

<ul>
<li><em>service.contract</em> : the service contract</li>
<li><em>service.provider</em> : the component providing the service</li>
<li><em>service.id</em> : an integer uniquely identifying the service. Note that this number is not retained over registrations.</li>
</ul>

<p>Providers can add any property by passing a property map (<code>string -&gt; object</code>) to the <em>registerService</em> method:</p>

<pre><code>start: function() {
    this.reg = hub.registerService(this, contract, {"myprop": "myvalue", "myprop2" : 1});
}
</code></pre>

<h2>Looking for a service and using it</h2>

<p>In addition to publishing services, components can also consume them. To use a service, the component must:</p>

<ol>
<li>Look for the service</li>
<li>Get the service and use it</li>
<li>Release the service.</li>
</ol>

<p><em>1) Service Lookup</em><br/>
Service lookup can be done by contract and/or properties (using a filter):</p>

<pre><code>// Look for all services implementing the given contract
var refs[] = hub.getServiceReferences(contract);

// Look for all services implementing the given contract, with 'myprop' = 'myvalue'
refs[] = hub.getServiceReferences(contract, function(ref) {
    return ref.getProperty("myprop") === "myvalue"
));

// By property only
refs[] = hub.getServiceReferences(null, function(ref) {
    return ref.getProperty("myprop") === "myvalue"
));

// Get all services
refs[] = hub.getServiceReferences();
</code></pre>

<p>You need to expect to get an empty array if no services match the request. The filter is a function receiving the
<code>ServiceReference</code> to check. It must return <code>true</code> if the service matches (and will therefore be selected), <code>false</code> otherwise.</p>

<p>The previous methods return an array, however if you want only one provider, you can use:</p>

<pre><code>// Look for a service implementing the given contract
var ref = hub.getServiceReference(contract);

// Look for a service implementing the given contract, with 'myprop' = 'myvalue'
ref = hub.getServiceReference(contract, function(ref) {
    return ref.getProperty("myprop") === "myvalue"
));
</code></pre>

<p>In that case, you have to check if the result is <code>null</code> (no matching provider).</p>

<p><em>2) Service Binding</em><br/>
Once you get the reference you want to use, you need to retrieve the service object. You achieve this using the <code>getService</code> method:</p>

<pre><code>var ref = ...;
var svc = hub.getService(this, ref);
if (svc != null) {
    svc.doSomething();
}
</code></pre>

<p>The <code>getService</code> function retrieves the service object attached to the provided reference. You need to check against
<code>null</code> because the service provider may have unregistered the service in between. If the service object is not <code>null</code>,
you can use the service object.</p>

<p><em>3) Releasing services</em><br/>
Once your component does not need a service anymore, it <em>must</em> release it using the <code>ungetService</code> method:</p>

<pre><code>var ref = ...
// ... some code using the reference
hub.ungetService(ref);
</code></pre>

<p><em>The all in one example</em></p>

<pre><code>var contract = {
     hello : function() {}
 };

 var provider = {
     configure : function(hub) {
         this.hub = hub;
     },
     start: function() {
         this.reg = this.hub.registerService(this, contract);
     },
     stop: function() {
         // Even though H-Ubu will manage it, I will unregister my service myself
         this.hub.unregisterService(this.reg);
     },
     getComponentName: function() { return "provider"; },
     hello : function() {
         return "Hello";
     }
 };

 var consumer = {
     configure : function(hub) {
         this.hub = hub;
     },
     start: function() { },
     stop: function() {
         if (this.ref !== undefined &amp;&amp; this.ref != null) {
             this.hub.ungetService(this, this.ref);
         }
     },
     getComponentName: function() { return "consumer"; },
     doSomething : function() {
         this.ref = this.hub.getServiceReference(contract);
         if (this.ref !== undefined &amp;&amp; this.ref != null) {
             var svc = this.hub.getService(this, this.ref);
             if (svc != null) {
                 return svc.hello() + " you";
             }
         }
     }
 };

 hub
     .registerComponent(provider)
     .registerComponent(consumer)
     .start();

 console.log(doSomething());

 hub.stop();
</code></pre>

<h2>Listening Service Events</h2>

<p>Services are dynamic by nature. So, they can be published, modified and unpublished at any time. Be aware that,
depending on your application, this dynamism may be limited but may still exist.</p>

<p>So, to track service dynamism, H-Ubu's components can implement service listeners. These listeners are notified when a
(matching) service arrives, leaves or is modified. As for service lookup, registering a service listener can
select the matching services by contract and/or by properties. To be notified, you need to register a <code>Service Listener</code>
object on the hub. This object contains:</p>

<ul>
<li><code>contract</code> : the contract required (may be <code>null</code>)</li>
<li><code>filter</code> : a filter, i.e. a function checking the properties of a given <code>Service Reference</code> (may be <code>null</code>)</li>
<li><code>listener</code> : a function receiving a <code>Service Event</code> object. This attribute is mandatory.</li>
</ul>

<p>So, a valid listener interested in providers implementing the <code>MyContract</code> service could be:</p>

<pre><code>var listenAllMyContractService = {
        contract : myContract,
        // no filter
        listener : function(event) {
            if (event.getType() === SOC.ServiceEvent.REGISTERED) {
                // Do something on service arrival
            } else if (event.getType() === SOC.ServiceEvent.UNREGISTERING) {
                // Do something on service departure
            }
        }
    }
</code></pre>

<p>We can also have a contract and a filter, such as:</p>

<p>var listenAllFrenchContractService = {
            contract : myContract,
            filter : function(ref) {
                return ref.getProperty("lg") === "fr";
            },
            listener : function(event) {
                if (event.getType() === SOC.ServiceEvent.REGISTERED) {
                    // Do something on service arrival
                } else if (event.getType() === SOC.ServiceEvent.UNREGISTERING) {
                    // Do  something on service departure
                }
            }
        }</p>

<p>Once your listeners are defined, you can register them using the <code>registerServiceListener</code> function:</p>

<pre><code>    hub.registerServiceListener(listenAllMyContractService);
    hub.registerServiceListener(listenAllFrenchContractService);
</code></pre>

<p>Don't forget to unregister service listeners when you are not interested in those events anymore. As service listeners
are not attached to components, they are not unregistered automatically.</p>

<pre><code>    hub.unregisterServiceListener(listenAllMyContractService);
    hub.unregisterServiceListener(listenAllFrenchContractService);
</code></pre>

<p>Service listener filters should be stateless and rely on the given service reference only.</p>

<h2>Service Modification</h2>

<p>The previous section has shown how you can handle service arrival and departure, but there is another type of event:
service modification. A modification happens when the service provider changes the service properties.</p>

<p>A service listener with a filter receives two type of events when a service is modified:</p>

<ul>
<li><code>SOC.ServiceEvent.MODIFIED</code> when the service is modified, and still matches the filter or matches the filter for the first time</li>
<li><code>SOC.ServiceEvent.MODIFIED_ENDMATCH</code> when the service is modified but <em>no longer</em> matches the filter</li>
</ul>

<p>So, be careful in that the <em>MODIFIED</em> event can be considered as a service arrival if the filter matches against the reference for the first time.</p>

<h2>Creating your own service registry</h2>

<p>You can create your own service registry for a specific hub:</p>

<pre><code>var registry = new SOC.ServiceRegistry(hub);
</code></pre>

<p>Be careful, this means that the hub now has two service registries.</p>

                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2010-2012
                        <a href="http://www.arrow-group.eu/">Arrow-Group</a>.
            All Rights Reserved.      
            
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
